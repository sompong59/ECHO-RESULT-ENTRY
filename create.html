<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo LogSystem </title>
    <link rel="icon" type="logo/png" href="logo/icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao+Looped:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tealMain: 'rgb(0, 150, 136)',
                        tealLight: 'rgba(0, 150, 136, 0.1)',
                        tealDark: 'rgb(0, 121, 107)'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans Lao Looped', sans-serif; background-color: #f4f7f6; color: #333; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgb(0, 150, 136); border-radius: 10px; }
        .compact-input { padding: 0.5rem 0.75rem; font-size: 0.875rem; border-radius: 0.75rem; }
        
        /* ປັບສີ Dropdown (Select) ໃຫ້ເປັນໂທນລະບົບ */
        select option { background-color: white; color: #333; }
        select option:hover { background-color: rgb(0, 150, 136) !important; color: white !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-[rgb(0,150,136)] text-white shadow-md p-3 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-8">
                <h1 class="font-bold text-lg flex items-center">
                    <i class="fas fa-heartbeat mr-2"></i> ECHO LOG SYSTEM
                </h1>

                  <div class="hidden md:flex items-center gap-6 text-sm">
                    <a href="index.html" class="bg-white/30 px-4 py-2 rounded-xl font-bold flex items-center gap-2">
                        <i class="fas fa-home"></i> ໜ້າຫຼັກ
                    </a>
                  
                </div>
              
            </div>
            <span class="text-[10px] font-bold bg-white/20 px-3 py-1 rounded-full border border-white/30 uppercase tracking-widest">Medical Records</span>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto w-full p-4 flex-1 flex flex-col gap-4">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 flex flex-col gap-5">
            <form id="createForm" class="space-y-5">
                
                <div>
                    <h2 class="text-[rgb(0,150,136)] font-bold text-sm mb-4 flex items-center border-b border-tealMain/10 pb-2">
                        <i class="fas fa-id-card mr-2"></i> ຂໍ້ມູນຄົນເຈັບ (Patient Information)
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                        <div class="md:col-span-2">
                            <label class="block text-[11px] font-bold text-gray-500 mb-1">ID PATIENT</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-tealMain">
                                    <i id="searchIcon" class="fas fa-search text-xs"></i>
                                </span>
                                <input type="text" id="c_id" oninput="handleIdSearch(this.value)" class="compact-input block w-full pl-9 border border-tealMain/30 focus:ring-2 focus:ring-tealMain outline-none font-bold text-tealDark bg-tealLight/20" placeholder="P0000">
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-[11px] font-bold text-gray-500 mb-1">DATE</label>
                            <input type="text" id="c_date" readonly class="compact-input block w-full bg-gray-50 border border-gray-200 text-gray-600 outline-none">
                        </div>
                        <div class="md:col-span-4">
                            <label class="block text-[11px] font-bold text-gray-500 mb-1">FULL NAME</label>
                            <input type="text" id="c_name" readonly class="compact-input block w-full bg-gray-50 border border-gray-200 text-gray-800 font-bold outline-none">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-[11px] font-bold text-gray-500 mb-1 text-center">GENDER</label>
                            <input type="text" id="c_gender" readonly class="compact-input block w-full text-center bg-gray-50 border border-gray-200 font-bold outline-none">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-[11px] font-bold text-gray-500 mb-1 text-center">AGE</label>
                            <input type="text" id="c_age" readonly class="compact-input block w-full text-center bg-gray-50 border border-gray-200 font-bold outline-none">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-[11px] font-bold text-gray-500 mb-1">PHONE</label>
                            <input type="text" id="c_phone" readonly class="compact-input block w-full bg-gray-50 border border-gray-200 font-bold outline-none">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-2">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-tealMain uppercase">ບ້ານ (Village)</span>
                        <input type="text" id="c_village" readonly class="bg-transparent text-sm font-bold text-gray-700 outline-none mt-1 border-b border-gray-100 pb-1">
                    </div>
                    <div class="flex flex-col md:border-l md:border-gray-100 md:pl-4">
                        <span class="text-[10px] font-bold text-tealMain uppercase">ເມືອງ (District)</span>
                        <input type="text" id="c_district" readonly class="bg-transparent text-sm font-bold text-gray-700 outline-none mt-1 border-b border-gray-100 pb-1">
                    </div>
                    <div class="flex flex-col md:border-l md:border-gray-100 md:pl-4">
                        <span class="text-[10px] font-bold text-tealMain uppercase">ແຂວງ (Province)</span>
                        <input type="text" id="c_province" readonly class="bg-transparent text-sm font-bold text-gray-700 outline-none mt-1 border-b border-gray-100 pb-1">
                    </div>
                </div>

                <div>
                    <label class="block text-[11px] font-bold text-gray-500 mb-1 uppercase">ທ່ານໝໍຜູ່ສົ່ງກວດ (REFERRING DOCTOR)</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-tealMain pointer-events-none">
                            <i class="fas fa-stethoscope"></i>
                        </span>
                        <select id="c_doctor" class="compact-input block w-full pl-9 border border-gray-200 focus:ring-2 focus:ring-tealMain focus:border-tealMain outline-none shadow-sm font-semibold appearance-none bg-white text-tealDark cursor-pointer">
                            <option value="">-- ເລືອກທ່ານໝໍ --</option>
                            <option value="Dr. Somchai">Dr. Somchai</option>
                            <option value="Dr. Keo">Dr. Keo</option>
                            <option value="Dr. Anousone">Dr. Anousone</option>
                        </select>
                        <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-tealMain pointer-events-none">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </span>
                    </div>
                </div>

                <div class="bg-white border-2 border-tealMain/20 rounded-2xl p-4 overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-tealMain flex items-center">
                            <i class="fas fa-list-check mr-2"></i> ລາຍການກວດເອໂກ (EXAM LIST)
                        </h3>
                        <div class="relative w-64">
                            <input type="text" id="gridSearch" onkeyup="filterGrid()" class="w-full pl-8 pr-3 py-1.5 border border-gray-200 rounded-lg text-xs outline-none focus:ring-2 focus:ring-tealMain" placeholder="ຄົ້ນຫາລາຍການ...">
                            <i class="fas fa-filter absolute left-2.5 top-2 text-gray-400 text-[10px]"></i>
                        </div>
                    </div>
                    
                    <div id="priceGrid" class="grid grid-cols-1 md:grid-cols-3 gap-3 max-h-56 overflow-y-auto custom-scrollbar pr-2 font-bold">
                        </div>
                </div>

                <div class="flex flex-col md:flex-row items-stretch gap-4 pt-2">
                    <div class="flex-1 bg-[rgb(0,150,136)] text-white rounded-xl p-4 flex justify-between items-center shadow-lg">
                        <div class="flex flex-col">
                            <span class="text-[10px] font-bold opacity-75 uppercase">Total Amount</span>
                            <span class="text-xs font-bold">ລາຄາລວມທັງໝົດ</span>
                        </div>
                        <div id="totalDisplay" class="text-2xl font-black tracking-tight">0 Kip</div>
                    </div>

                    <div class="flex gap-3 w-full md:w-auto">
                        <button type="button" id="btnSave" onclick="saveData()" class="flex-1 md:flex-none bg-[rgb(0,150,136)] hover:bg-tealDark text-white font-bold py-4 px-10 rounded-xl transition-all shadow-md flex items-center justify-center active:scale-95">
                            <i class="fas fa-save mr-2"></i> ບັນທຶກຂໍ້ມູນ
                        </button>
                        <a href="index.html" class="flex items-center justify-center px-8 py-4 bg-white border border-gray-300 hover:bg-gray-50 text-gray-500 font-bold rounded-xl active:scale-95 transition-all">
                            <i class="fas fa-times mr-2"></i> ຍົກເລີກ
                        </a>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <script>
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbwwi40SYZ6JyoMpqIUEx3FchSt5efFixh62JGEEj5CpaGydwRkntsWhC7dVYDjcGZZXBw/exec'; 
        let priceListData = [];
        let selectedItems = [];
        let searchTimeout;

        async function initialize() {
            document.getElementById('c_date').value = new Date().toLocaleDateString('lo-LA');
            const cachedData = localStorage.getItem('priceListCache');
            if (cachedData) {
                priceListData = JSON.parse(cachedData);
                renderGrid(priceListData);
            }
            fetchExamData();
        }

        async function fetchExamData() {
            try {
                const resp = await fetch(webAppUrl);
                priceListData = await resp.json();
                localStorage.setItem('priceListCache', JSON.stringify(priceListData));
                renderGrid(priceListData);
            } catch (e) { console.error(e); }
        }

        function handleIdSearch(id) {
            clearTimeout(searchTimeout);
            const icon = document.getElementById('searchIcon');
            if (!id.trim()) { clearFields(); icon.className = "fas fa-search text-xs"; return; }
            icon.className = "fas fa-spinner fa-spin text-xs";
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${webAppUrl}?id=${id.trim()}`);
                    const data = await response.json();
                    if (data.found) {
                        ['name', 'age', 'gender', 'village', 'district', 'province', 'phone'].forEach(f => {
                            document.getElementById(`c_${f}`).value = data[f] || '';
                        });
                        Swal.fire({
                            toast: true, position: 'top-end', icon: 'success',
                            title: `ດຶງຂໍ້ມູນ: ${data.name}`, showConfirmButton: false, timer: 1500
                        });
                    } else { clearFields(); }
                } catch (e) { console.error(e); }
                icon.className = "fas fa-search text-xs";
            }, 600);
        }

        function clearFields() {
            ['c_name', 'c_age', 'c_gender', 'c_village', 'c_district', 'c_province', 'c_phone'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
        }

        function renderGrid(data) {
            const html = data.map(item => {
                const isSelected = selectedItems.some(i => i.type === item.type);
                return `
                    <div onclick="toggleItem('${item.type}', ${item.price}, this)" 
                         class="cursor-pointer border-2 p-3 rounded-xl flex justify-between items-center transition-all ${isSelected ? 'border-tealMain bg-tealLight' : 'border-gray-50 bg-white hover:border-tealMain/30 shadow-sm'}">
                        <div class="flex items-center">
                            <div class="w-4 h-4 border-2 rounded mr-3 flex items-center justify-center transition-colors ${isSelected ? 'bg-tealMain border-tealMain' : 'border-gray-300'}">
                                ${isSelected ? '<i class="fas fa-check text-[8px] text-white"></i>' : ''}
                            </div>
                            <span class="text-xs ${isSelected ? 'text-tealDark font-bold' : 'text-gray-700 font-semibold'}">${item.type}</span>
                        </div>
                        <span class="text-xs font-black text-tealMain">${Number(item.price).toLocaleString()}</span>
                    </div>`;
            }).join('');
            document.getElementById('priceGrid').innerHTML = html || '<div class="col-span-3 text-center text-gray-400 text-xs py-10">ບໍ່ພົບລາຍການ</div>';
        }

        function toggleItem(type, price, element) {
            const idx = selectedItems.findIndex(i => i.type === type);
            if(idx > -1) { selectedItems.splice(idx, 1); } 
            else { selectedItems.push({type, price}); }
            const q = document.getElementById('gridSearch').value.toLowerCase();
            renderGrid(priceListData.filter(i => i.type.toLowerCase().includes(q)));
            updateTotal();
        }

        function updateTotal() {
            const total = selectedItems.reduce((sum, i) => sum + i.price, 0);
            document.getElementById('totalDisplay').innerText = `${total.toLocaleString()} Kip`;
        }

        function filterGrid() {
            const q = document.getElementById('gridSearch').value.toLowerCase();
            renderGrid(priceListData.filter(i => i.type.toLowerCase().includes(q)));
        }

        async function saveData() {
            if(!document.getElementById('c_name').value) return Swal.fire('ແຈ້ງເຕືອນ', 'ກະລຸນາຄົ້ນຫາ ID ຄົນເຈັບກ່ອນ', 'warning');
            if(!document.getElementById('c_doctor').value) return Swal.fire('ແຈ້ງເຕືອນ', 'ກະລຸນາເລືອກທ່ານໝໍ', 'warning');
            if(selectedItems.length === 0) return Swal.fire('ແຈ້ງເຕືອນ', 'ກະລຸນາເລືອກລາຍການກວດ', 'warning');

            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            Swal.fire({ title: 'ກຳລັງບັນທຶກ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const payload = {
                action: 'add',
                id: document.getElementById('c_id').value,
                date: document.getElementById('c_date').value,
                name: document.getElementById('c_name').value,
                age: document.getElementById('c_age').value,
                gender: document.getElementById('c_gender').value,
                village: document.getElementById('c_village').value,
                district: document.getElementById('c_district').value,
                province: document.getElementById('c_province').value,
                phone: document.getElementById('c_phone').value,
                doctor: document.getElementById('c_doctor').value,
                items: selectedItems.map(i => ({ list: i.type, price: i.price }))
            };

            try {
                await fetch(webAppUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                Swal.fire({ icon: 'success', title: 'ບັນທຶກຂໍ້ມູນສຳເລັດ', timer: 1500 }).then(() => window.location.href = 'index.html');
            } catch (e) { 
                Swal.fire('Error', 'ເກີດຂໍ້ຜິດພາດ', 'error'); 
                btn.disabled = false;
            }
        }
        window.onload = initialize;
    </script>
</body>
</html>